image: node:latest

stages:
  - test
  - build
  - publish

.install_tools: &install_tools |
  export DEBIAN_FRONTEND=noninteractive
  apt update
  apt -y install debhelper osc
  wget http://binaryindex.uib.gmbh/development/opsi-dev-tools/linux/x64/opsi-dev-tools_linux_x64_1.0.70.tar.gz
  tar -xf opsi-dev-tools_linux_x64_1.0.70.tar.gz
  # apt -y install python3-dev
  # pip3 install --trusted-host pypi.uib.gmbh --index-url http://pypi.uib.gmbh:8080/simple opsi-dev-tools
  # pip3 install poetry

test:lint:
  stage: test
  script: |
    cd opsiweb
    npm install
    npm run lint

test:jtest:
  stage: test
  script: |
    cd opsiweb
    npm install
    npm run test
  coverage: /All files\s*\|\s*([\d\.]+)/
  artifacts:
    reports:
      cobertura: opsiweb/coverage/clover.xml

build:static-app:
  stage: build
  script: |
    cd opsiweb
    npm install
    npm run generate
  artifacts:
    name: 'opsi-webgui'
    paths:
      - opsiweb/dist
    expire_in: 2 day
  # only:
  #   - develop

publish:binary-index:
  stage: publish
  dependencies:
    - build:static-app
  script:
    - *install_tools
    - '[ "$CI_COMMIT_TAG" = "" ] && ./opsi-dev-tool -l info --binary-push opsiweb/dist opsi-webgui linux x64 $CI_JOB_ID'
    - '[ "$CI_COMMIT_TAG" = "" ] || ./opsi-dev-tool -l info --binary-push opsiweb/dist opsi-webgui linux x64'
  when: manual

publish:obs_int:
  stage: publish
  dependencies:
    - build:static-app
  script:
    - *install_tools
    - ./opsi-dev-tool -l info --obs-update-package https://obs.uib.gmbh home:uibmz:opsi:4.2:development
  when: manual
  # only:
  #   - tags

# publish:obs_ext:
#   stage: publish
#   dependencies:
#     - build:static-app
#   script:
#     - *install_tools
#     - ./opsi-dev-tool -l info --obs-update-package https://build.opensuse.org home:uibmz:opsi:4.2:development
#   when: manual
  # only:
  #   - tags