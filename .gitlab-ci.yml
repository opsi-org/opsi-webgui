image: mcr.microsoft.com/playwright:v1.15.2-focal

stages:
  - init
  - test
  - build
  - publish

# variables:
#   GIT_SUBMODULE_STRATEGY: recursive
# run with specific submodule-branch defined in .gitmodules
# # provides a variable "GIT_SUBMODULE_STRATEGY" that sets up submodules automatically
# # But then branch tracking doesn't work (doesn't seem to allow for specifying the --remote) flag
before_script:
  # - shopt -s expand_aliases
  # - alias npm-uib='dry --dry-save-package-json-to package-merged.json --dry-keep-package-json'
  - git clone --branch ${CI_COMMIT_BRANCH} https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.uib.gmbh/uib/opsiweb-ui-components.git opsiweb/uib-components
  - cd opsiweb/uib-components
  - git branch -a
  - ls -lah
  - cd -
  # - git submodule sync --recursive
  # - git submodule update --init --recursive # --remote

# variables:
  # PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
  # PLAYWRIGHT_BROWSERS_PATH: ".playwright/browsers/"
.define_globals: &define_globals |
  npm i -g dry-dry
  ls -lah /usr/bin/dry
  shopt -s expand_aliases
  alias npm-uib='dry --dry-save-package-json-to package-merged.json --dry-keep-package-json'

.install_tools: &install_tools |
  export DEBIAN_FRONTEND=noninteractive
  apt update
  apt -y install debhelper osc
  wget http://binaryindex.uib.gmbh/development/opsi-dev-tools/linux/x64/opsi-dev-tools_linux_x64_1.0.79.tar.gz
  tar -xf opsi-dev-tools_linux_x64_1.0.79.tar.gz

init:dry:
  stage: init
  # ./install.sh
  script:
    - cd opsiweb
    - *define_globals
    - npm-uib --help
    - npm-uib i
    - ls -lah
    - cat package-dry.json
    - cat package-merged.json
    - cat package.json
  artifacts:
    paths:
      - opsiweb/node_modules/
      # - /usr/lib/node_modules/dry-dry/
      # - /usr/bin/dry
    expire_in: 1 day

test:lint:
  stage: test
  script:
    - cd opsiweb
    - npm-uib run lint

test:test-unit:
  stage: test
  dependencies:
    - init:dry
  script:
    - cd opsiweb
    - *define_globals
    - npm-uib run test:unit
  coverage: /All files\s*\|\s*([\d\.]+)/
  artifacts:
    reports:
      cobertura: opsiweb/coverage/clover.xmlci

test:test-e2e:
  stage: test
  dependencies:
    - init:dry
  script:
    - cd opsiweb
    - *define_globals
    - npx playwright install
    - PORT=8888 nohup npm-uib run dev &
    - sleep 20
    - echo $PLAYWRIGHT_BROWSERS_PATH
    - npm-uib run test:e2e
  allow_failure: true
  artifacts:
    name: 'opsi-webgui-test-result-e2e'
    when: on_failure
    paths:
      - opsiweb/test-results/
    expire_in: 2 day

test:test-integration:
  stage: test
  dependencies:
    - init:dry
  script:
    - cd opsiweb
    - *define_globals
    - npx playwright install
    - PORT=8888 nohup npm-uib run dev &
    - PORT=3003 nohup npm-uib run story &
    - sleep 60
    - npm-uib run test:integration
  allow_failure: true
  artifacts:
    name: 'opsi-webgui-test-result-integration'
    when: on_failure
    paths:
      - opsiweb/test-results/
    expire_in: 2 day

build:static-app:
  stage: build
  dependencies:
    - init:dry
    - test:lint
    #- test:jtest
  script:
    - cd opsiweb
    - *define_globals
    - npm-uib run generate
  artifacts:
    name: 'opsi-webgui'
    paths:
      - opsiweb/dist
    expire_in: 1 day
  only:
    - develop
    - tags

publish:binary-index:
  stage: publish
  dependencies:
    - build:static-app
  script:
    - *install_tools
    - '[ "$CI_COMMIT_TAG" = "" ] && ./opsi-dev-tool -l debug --binary-push opsiweb/dist opsi-webgui linux x64 $CI_JOB_ID'
    - '[ "$CI_COMMIT_TAG" = "" ] || ./opsi-dev-tool -l debug --binary-push opsiweb/dist opsi-webgui linux x64'
  only:
    - develop

build:addon:
  stage: build
  dependencies:
    - build:static-app
  script: |
    *install_tools
    openssl req -x509 -newkey rsa:4096 -keyout /var/tmp/key.pem -out /var/tmp/cert.pem -sha256 -days 365 --nodes -subj '/CN=localhost
    mkdir -p backend/webgui/data
    mv opsiweb/dist backend/webgui/data/app
    version=$(grep ADDON_VERSION backend/python/const.py | cut -d'"' -f2)
  only:
    - tags
  artifacts:
    name: 'webgui'
    paths:
      - backend/webgui
    expire_in: 2 day

publish:obs_int:
  stage: publish
  dependencies:
    - build:static-app
  script:
    - *install_tools
    - ./opsi-dev-tool -l debug --obs-update-package https://obs.uib.gmbh home:uibmz:opsi:4.2:development
  only:
    - tags

# publish:obs_ext:
#   stage: publish
#   dependencies:
#     - build:static-app
#   script:
#     - *install_tools
#     - ./opsi-dev-tool -l info --obs-update-package https://build.opensuse.org home:uibmz:opsi:4.2:development
#   when: manual
#   only:
#    - tags
