<template>
  <div
    :class="{
      [themeclass]: true,
      mobile: $mq === 'mobile',
      desktop: $mq === 'desktop',
      sidebar_collapsed: !sidebarAttr.expanded && $mq!=='mobile',
      sidebar_expanded: sidebarAttr.expanded && $mq!=='mobile',
      QPwithSBexpanded: showQuickPanel && sidebarAttr.expanded,
      QPwithSBcollapsed: showQuickPanel && !sidebarAttr.expanded
    }"
  >
    <BarBTop class="topbar_content">
      <template #mobilemenu>
        <b-button variant="primary" size="sm" class="h-100 border-0" :pressed.sync="sidebarAttr.visible">
          <span class="sr-only">{{ $t('menu.open-sidemenu.sr-only') }}</span>
          <b-icon font-scale="1.5" :icon="icon.navmenu" />
        </b-button>
      </template>
    </BarBTop>
    <BarBSide v-once class="sidebar_content" :attributes="sidebarAttr" :sidebarshown.sync="sidebarAttr.visible" />
    <b-sidebar
      id="quickpanel"
      right
      :visible="showQuickPanel"
      no-header
      :backdrop="$mq == 'mobile'"
      :bg-variant="$mq == 'mobile'? 'dark' : 'sidebar-bg'"
      :text-variant="$mq == 'mobile'? 'color' : 'sidebar-text'"
      no-close-on-route-change
      @hidden="showQuickPanel = false"
    >
      <b-button
        :pressed.sync="showQuickPanel"
        :title="showQuickPanel ? $t('Hide Quick Panel'): $t('Show Quick Panel')"
        size="sm"
        class="mt-3 border-0 mr-3 float-right"
        variant="outline-primary"
      >
        <b-icon :icon="icon.quickpanel" />
      </b-button>
      <b-container class="mt-5">
        <b-row class="text-small mb-2">
          <b>{{ $t('Quick Selections') }} </b>
        </b-row>

        <b-button v-b-toggle.depots block class="text-left border-0 p-0" variant="outline-primary">
          {{ $t('Servers') }} <b-icon class="float-right" font-scale="0.9" :icon="icon.arrowFillDown" />
        </b-button>
        <b-collapse id="depots" accordion="quickpanelgroups" role="tabpanel">
          <div class="scrollcontent">
            <TreeTSDepots :open="true" type="propertyvalues" classes="treeselect_quickpanel" />
          </div>
        </b-collapse>
        <b-button v-b-toggle.clientgroup block class="text-left border-0 p-0" variant="outline-primary">
          {{ $t('Client Groups') }} <b-icon class="float-right" font-scale="0.9" :icon="icon.arrowFillDown" />
        </b-button>
        <b-collapse id="clientgroup" visible accordion="quickpanelgroups" role="tabpanel">
          <div class="scrollcontent">
            <TreeTSHostGroups :open="true" type="propertyvalues" classes="treeselect_quickpanel" />
          </div>
        </b-collapse>
        <b-button v-b-toggle.productgroup block class="text-left border-0 p-0" variant="outline-primary">
          {{ $t('Product Groups') }} <b-icon class="float-right" font-scale="0.9" :icon="icon.arrowFillDown" />
        </b-button>
        <b-collapse id="productgroup" accordion="quickpanelgroups" role="tabpanel">
          <div class="scrollcontent">
            <TreeTSProductGroups :open="true" type="propertyvalues" classes="treeselect_quickpanel" />
          </div>
        </b-collapse>
      </b-container>
    </b-sidebar>
    <div class="main_content">
      <b-button
        v-if="!showQuickPanel"
        :pressed.sync="showQuickPanel"
        :title="showQuickPanel ? $t('Hide Quick Panel'): $t('Show Quick Panel')"
        size="sm"
        class="mt-1 border-0 float-right"
        variant="outline-primary"
      >
        <b-icon :icon="icon.quickpanel" />
      </b-button>
      <AlertAAlertAutoDismissible ref="statusAlert" data-testid="statusAlert" />
      <AlertAAlert ref="errorAlert" data-testid="errorAlert" />
      <AlertAAlert ref="expiringAlert" /> <!-- referenced in DivDCountdowntimer, any changes should be checked with expiring-session-behaviour-->
      <Nuxt />
    </div>
  </div>
</template>

<script lang="ts">
import { Component, namespace, Watch, Vue } from 'nuxt-property-decorator'
import { MBus } from '../mixins/messagebus'
import { Configserver } from '../mixins/get'
import { Icons } from '../mixins/icons'
import { ChangeObj } from '../.utils/types/tchanges'
import { IObjectString2Boolean } from '../.utils/types/tgeneral'

const settings = namespace('settings')
const changes = namespace('changes')
const cache = namespace('data-cache')
const config = namespace('config-app')

interface SideBarAttr {
    visible: boolean,
    expanded: boolean
}

@Component({ mixins: [MBus, Configserver, Icons] })
export default class LayoutDefault extends Vue {
  icon:any
  $t: any
  $mq: any
  $axios: any
  wsInit: any // mixin
  wsBus: any // mixin
  getOpsiConfigServer:any

  @config.Getter public config!: IObjectString2Boolean
  @config.Mutation public setConfig!: (obj: IObjectString2Boolean) => void
  @settings.Getter public colortheme!: any
  @changes.Getter public changesProducts!: Array<ChangeObj>
  @changes.Getter public changesHostParam!: Array<ChangeObj>
  @cache.Getter public opsiconfigserver!: string
  @cache.Mutation public setOpsiconfigserver!: (s: string) => void

  sidebarAttr: SideBarAttr = { visible: true, expanded: true }

  showQuickPanel:boolean = false

  @Watch('opsiconfigserver', { deep: true }) async serverChanged () {
    await this.checkServer()
  }

  get helpSavemode () {
    return [
      { label: this.$t('label.on'), description: this.$t('description.quicksave.on') },
      { label: this.$t('label.off'), description: this.$t('description.quicksave.off') }
    ]
  }

  get themeclass () {
    return (this.colortheme && this.colortheme.title === 'light') ? 'theme-light' : 'theme-dark'
  }

  get username () {
    return localStorage.getItem('username')
  }

  async mounted () {
    window.onbeforeunload = this.confirmToSaveChanges
    await this.checkServer()
    await this.checkConfig()
    if (this.wsBus === undefined) {
      this.wsInit()
    }
    if (this.$mq === 'mobile') {
      this.sidebarAttr.visible = false
    } else {
      this.sidebarAttr.visible = true
    }
  }

  confirmToSaveChanges () {
    if (this.changesProducts.filter(o => o.user === this.username).length !== 0 || this.changesHostParam.filter(o => o.user === this.username).length !== 0) {
      return true
    } else {
      return null
    }
  }

  head () {
    return {
      link: [
        // { rel: 'stylesheet', href: (this.colortheme) ? this.colortheme.rel : '' },
        { rel: 'stylesheet', href: 'themes/opsi.css' },
        { rel: 'stylesheet', href: 'css/colors-all.css' },
        { rel: 'stylesheet', href: 'css/custom.css' },
        { rel: 'stylesheet', href: (this.colortheme && this.colortheme.title === 'light') ? 'css/colors-light.css' : 'css/colors-dark.css' }
      ]
    }
  }

  async checkServer () {
    if (this.opsiconfigserver === '') {
      const alertRef = (this.$refs.statusAlert as any)
      await this.getOpsiConfigServer(alertRef)
    }
  }

  async checkConfig () {
    try {
      const response = (await this.$axios.$get('/api/user/configuration')).configuration
      this.setConfig(response)
    } catch (error: any) {
      const detailedError = ((error?.response?.data?.message) ? error.response.data.message : '') + ' ' + ((error?.response?.data?.detail) ? error.response.data.detail : '')
      const ref = (this.$refs.errorAlert as any)
      ref.alert(detailedError, 'danger')
    }
  }
}
</script>

<style>
.scrollcontent {
  min-height: 40vh !important;
  overflow-x:auto;
  overflow-y: auto;
}
.topbar_content {
  z-index: 1000;
  width: 100% !important;
  max-height: 100px;
}
.topbar_content,
.sidebar_content ,
.footer_content {
  color: var(--light) !important;
}
.main_content{
  position:absolute;
  margin-top: var(--margin-top-maincontent);
  margin-left: var(--margin-left-maincontent);
  overflow-x: auto;
  overflow-y: hidden;
  width: calc(100% - 2 * var(--margin-left-maincontent));
  min-height: -webkit-fill-available;
}
.main_content > .container-fluid{
  min-height: 350px;
}
:not(.mobile).sidebar_collapsed .main_content{
  margin-left: calc(var(--margin-left-maincontent-if-sidebar-collpased));
  width: calc(100% - var(--margin-left-maincontent-if-sidebar-collpased) - var(--margin-left-maincontent));
}
:not(.mobile).sidebar_expanded .main_content{
  margin-left: var(--margin-left-maincontent-if-sidebar-expanded);
  width: calc(100% - var(--margin-left-maincontent-if-sidebar-expanded) - var(--margin-left-maincontent));
}
:not(.mobile).QPwithSBexpanded .main_content{
  width: calc(100% - 590px) !important;
}
:not(.mobile).QPwithSBcollapsed .main_content{
  width: calc(100% - 470px) !important;
}
#quickpanel {
  top: calc(var(--height-navbar) - 2px) !important;
  width: 400px;
  height: 100% !important;
}
.sidebar-bg {
  background-color: var(--background) !important;
}
.sidebar-text{
  color: var(--color) !important;
}
</style>
