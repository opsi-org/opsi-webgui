project:
  name: opsi-webgui
  version: &project_version 4.3.15
  description: opsi webgui
  homepage: http://www.opsi.org
  licenses:
    - license: AGPL-3.0
  maintainer: uib GmbH <info@uib.de>
git:
  hooks:
    pre-push: |
      cd /workspace/opsiweb/
      file=".tmp_prepush_result_changed_files.log"
      echo "> Test Changed files"
      bash ./scripts/devhelper.sh all-changed .test.component.js test:all:components / $file || exit_code=$?
      echo "====================================================== Check test files"
      bash ./scripts/playwright_coverage_by_files.sh $file
      # rm $file
      echo "======================================================"
      echo ""
      cd ..
      echo "exitcode $exit_code"
      exit $exit_code

package:
  name: opsi-webgui
  type: binary
  architecture: all
  depends:
    - opsiconfd (>= 4.3.0.37)
  source_script: |
    mkdir -p "${DST}/rootfs/var/lib/opsiconfd/addons"
    cp -a "${SRC}/backend/addon/webgui" "${DST}/rootfs/var/lib/opsiconfd/addons/webgui"
    mkdir -p "${DST}/rootfs/var/lib/opsiconfd/addons/webgui/data"
    ls -la "${SRC}/opsiweb/dist/"
    cp -a "${SRC}"/opsiweb/dist/* "${DST}/rootfs/var/lib/opsiconfd/addons/webgui/data/app"
  postinst_script:
    - echo "OPSI webgui folder '/var/lib/opsiconfd/addons/webgui'"
    - exit 0

pull-binaries:
  - name: opsi-webgui
    server-type: binaryindex
    destination: .
    extract: true
    post-script:
      - WEBGUI_VERSION=$(grep opsi-dev-tool.yml -A 10 -e "project" | grep -m 1 "version:" | awk '{print $3}')
      - zip -r opsi-webgui_${WEBGUI_VERSION}.zip webgui
    os: linux
    architecture: x64
    version: *project_version
    branch: development
    server-url: http://binaryindex.uib.gmbh
